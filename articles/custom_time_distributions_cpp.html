<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Custom time distributions (using C++) • NEXTNetR</title>
<!-- mathjax math --><script src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script><script>
  window.MathJax = {
    chtml: {
      fontURL: "https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/output/chtml/fonts/woff-v2"
    }
  };
</script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Custom time distributions (using C++)">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">NEXTNetR</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/NEXTNetR.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/custom_time_distributions_cpp.html">Custom time distributions (using C++)</a></li>
    <li><a class="dropdown-item" href="../articles/custom_time_distributions_r.html">Custom time distributions (using pure R)</a></li>
    <li><a class="dropdown-item" href="../articles/empirical_networks.html">Empirical Networks</a></li>
    <li><a class="dropdown-item" href="../articles/spatial_temporal_networks.html">Spatial and Temporal Networks</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/oist/NEXTNetR/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Custom time distributions (using C++)</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/oist/NEXTNetR/blob/master/vignettes/articles/custom_time_distributions_cpp.Rmd" class="external-link"><code>vignettes/articles/custom_time_distributions_cpp.Rmd</code></a></small>
      <div class="d-none name"><code>custom_time_distributions_cpp.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p><a href="https://oist.github.io/NEXTNetR/">NEXTNetR</a> provides a set of built-in time distributions
that can be used as transmission and recovery times in simulations, see
<code><a href="../reference/time_distributions.html">help(time_distributions)</a></code>. Additional distributions can be
defined by users through either R or C++ code. Here we discuss the C++
solution, which is significantly (orders of magnitudes!) faster, but
more complex. For the slower but simpler pure R solution, see
<code>vignette("custom_time_distributions_r")</code>.</p>
</div>
<div class="section level2">
<h2 id="loading-the-nextnetr-package">Loading the NEXTNetR package<a class="anchor" aria-label="anchor" href="#loading-the-nextnetr-package"></a>
</h2>
<p>We start with loading all required packages. If
<a href="https://oist.github.io/NEXTNetR/">NEXTNetR</a>is not already installed, see the <a href="https://oist.github.io/NEXTNetR/">website</a> for installation
instructions. To conveniently mix C++ and R code, we use the
<a href="https://cpp11.r-lib.org" class="external-link">cpp11</a> package together with <a href="https://github.com/r-lib/decor" class="external-link">decor</a>. To
implement a new distribution, our C++ code must be able to see global
symbols related to the <code>transmission_time</code> class defined by
the <a href="https://oist.github.io/NEXTNetR/">NEXTNetR</a> package. Unfortunately, R packages are
usually loaded in a way that prevents this. To work around this, we
therefore have to load NEXTNetR’s shared library manually
<em>before</em> importing the package. That way, we can specify
<code>local=TRUE</code> when we load the library to make symbols
globally visible. Note that this may not be required on all platforms.
Finally, we also load the <a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a> and
<a href="https://rpkgs.datanovia.com/ggpubr/" class="external-link">ggpubr</a> packages for plotting and set a nice theme.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Make sure the NEXTNetR shared library is loaded with local=FALSE</span></span>
<span><span class="co"># This has to be done *before* library(NEXTNetR)</span></span>
<span><span class="va">nnR.dir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/find.package.html" class="external-link">find.package</a></span><span class="op">(</span><span class="st">"NEXTNetR"</span><span class="op">)</span></span>
<span><span class="va">nnR.lib</span> <span class="op">&lt;-</span> <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nchar.html" class="external-link">nzchar</a></span><span class="op">(</span><span class="va">.Platform</span><span class="op">$</span><span class="va">r_arch</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">nnR.dir</span>, <span class="st">"libs"</span>, <span class="va">.Platform</span><span class="op">$</span><span class="va">r_arch</span>,</span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"NEXTNetR"</span>, <span class="va">.Platform</span><span class="op">$</span><span class="va">dynlib.ext</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">nnR.dir</span>, <span class="st">"libs"</span>,</span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"NEXTNetR"</span>, <span class="va">.Platform</span><span class="op">$</span><span class="va">dynlib.ext</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/dynload.html" class="external-link">dyn.load</a></span><span class="op">(</span><span class="va">nnR.lib</span>, local<span class="op">=</span><span class="cn">FALSE</span>, now<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Now we may load NEXTNetR</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://oist.github.io/NEXTNetR/">NEXTNetR</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># For cpp_source()</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://cpp11.r-lib.org" class="external-link">cpp11</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/r-lib/decor" class="external-link">decor</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># For plotting</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rpkgs.datanovia.com/ggpubr/" class="external-link">ggpubr</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme_get.html" class="external-link">theme_set</a></span><span class="op">(</span><span class="fu"><a href="https://rpkgs.datanovia.com/ggpubr/reference/theme_pubr.html" class="external-link">theme_pubr</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="implementing-a-custom-time-distribution-in-c">Implementing a custom time distribution in C++<a class="anchor" aria-label="anchor" href="#implementing-a-custom-time-distribution-in-c"></a>
</h2>
<p>To implement a custom time distribution, we have to implement the
<code>time_distribution</code> interface (i.e. abstract base class)
defined by the NEXTNet C++ library. The minimal set of functions an
implementation of that interface must provide are</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="kw">virtual</span> <span class="dt">double</span> density<span class="op">(</span><span class="dt">interval_t</span> tau<span class="op">)</span> <span class="at">const</span><span class="op">;</span></span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a><span class="kw">virtual</span> <span class="dt">double</span> survivalprobability<span class="op">(</span><span class="dt">interval_t</span> tau<span class="op">)</span> <span class="at">const</span><span class="op">;</span></span></code></pre></div>
<p>If only these two functions are provided, random samples of your
distribution will be generated by generating a uniformly distribution
random value between 0 and 1 and computing the corresponding quantile.
Since we have not override the quantile function, the quantile will be
computed by numerically inverting the survival function using bisection,
which is slow. If there is a more efficient way of generating samples,
you will thus want to also override the <code>sample</code> function</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="kw">virtual</span> <span class="dt">interval_t</span> sample<span class="op">(</span><span class="dt">rng_t</span> <span class="op">&amp;,</span> <span class="dt">interval_t</span> t<span class="op">,</span> <span class="dt">double</span> m<span class="op">)</span> <span class="at">const</span><span class="op">;</span></span></code></pre></div>
<p>This function must sample from the derived distribution conditioned
on <span class="math inline">\(t\)</span> and modulated with <span class="math inline">\(m\)</span>, see <code><a href="../reference/time_functions.html">help(time_functions)</a></code>
for a discussion of these parameters. Often, generating samples from the
unmodified distribution, i.e. for <span class="math inline">\(t=0\)</span> and <span class="math inline">\(m=1\)</span> is considerably simpler. Since this
is, on unweighted networks, also by far the most common case, a typical
strategy is to only optimize this case, i.e. to do</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="kw">virtual</span> <span class="dt">interval_t</span> sample<span class="op">(</span><span class="dt">rng_t</span> <span class="op">&amp;</span>rng<span class="op">,</span> <span class="dt">interval_t</span> t<span class="op">,</span> <span class="dt">double</span> m<span class="op">)</span> <span class="at">const</span> <span class="kw">override</span> <span class="op">{</span></span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">((</span>t <span class="op">==</span> <span class="fl">0.0</span><span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="op">(</span>m <span class="op">==</span> <span class="fl">1.0</span><span class="op">))</span> <span class="op">{</span></span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a>    <span class="co">// generate sample from base distribution</span></span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a>    <span class="cf">return</span> <span class="op">...</span></span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb4-6"><a href="#cb4-6" tabindex="-1"></a>  <span class="co">// Use numeric inversion of the survival function for the general case</span></span>
<span id="cb4-7"><a href="#cb4-7" tabindex="-1"></a>  <span class="cf">return</span> transmission_time<span class="op">::</span>sample<span class="op">(</span>rng<span class="op">,</span> t<span class="op">,</span> m<span class="op">);</span></span>
<span id="cb4-8"><a href="#cb4-8" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Finally, if the quantiles can be computed more efficiently than be
inverting the survival function, also override the quantile function</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="kw">virtual</span> <span class="dt">interval_t</span> survivalquantile<span class="op">(</span><span class="dt">double</span> u<span class="op">)</span> <span class="at">const</span><span class="op">;</span></span></code></pre></div>
<div class="section level3">
<h3 id="a-mixture-of-existing-distributions">A mixture of existing distributions<a class="anchor" aria-label="anchor" href="#a-mixture-of-existing-distributions"></a>
</h3>
<p>The following file <code>mixture_time.cpp</code> implements a
<em>mixture</em> of <span class="math inline">\(n\)</span> arbitrary
time distributions with given weights. It defines a class
<code>mixture_time_impl</code> which derives from the abstract base
class <code>time_distribution</code> and implements the
<code>sample</code>, <code>survivalprobability</code>, and
<code>density</code> methods. To create mixture distributions, it
provides a function <code>mixture_time</code> which converts the
parameters appropriately and returns an instance of the
<code>mixture_time_impl</code> as a <code>transmission_time_R</code>
(this type encapsulates C++ time distribution objects so that they can
be passed through R).</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="co">/* mixture_time.cpp */</span></span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;random&gt;</span></span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;cpp11.hpp&gt;</span></span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;cpp11/function.hpp&gt;</span></span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a></span>
<span id="cb6-7"><a href="#cb6-7" tabindex="-1"></a><span class="pp">#include </span><span class="im">"NEXTNetR/NEXTNetR_types.h"</span></span>
<span id="cb6-8"><a href="#cb6-8" tabindex="-1"></a><span class="pp">#include </span><span class="im">"nextnet/random.h"</span></span>
<span id="cb6-9"><a href="#cb6-9" tabindex="-1"></a></span>
<span id="cb6-10"><a href="#cb6-10" tabindex="-1"></a><span class="kw">using</span> <span class="kw">namespace</span> cpp11<span class="op">;</span></span>
<span id="cb6-11"><a href="#cb6-11" tabindex="-1"></a></span>
<span id="cb6-12"><a href="#cb6-12" tabindex="-1"></a><span class="kw">struct</span> mixture_time_impl <span class="op">:</span> <span class="kw">public</span> <span class="kw">virtual</span> transmission_time <span class="op">{</span></span>
<span id="cb6-13"><a href="#cb6-13" tabindex="-1"></a>  <span class="kw">virtual</span> <span class="dt">interval_t</span> sample<span class="op">(</span><span class="dt">rng_t</span> <span class="op">&amp;</span>rng<span class="op">,</span> <span class="dt">interval_t</span> t<span class="op">,</span> <span class="dt">double</span> m<span class="op">)</span> <span class="at">const</span> <span class="kw">override</span> <span class="op">{</span></span>
<span id="cb6-14"><a href="#cb6-14" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">((</span>t <span class="op">==</span> <span class="fl">0.0</span><span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="op">(</span>m <span class="op">==</span> <span class="fl">1.0</span><span class="op">))</span></span>
<span id="cb6-15"><a href="#cb6-15" tabindex="-1"></a>      <span class="cf">return</span> times<span class="op">.</span>at<span class="op">(</span>pick<span class="op">(</span>rng<span class="op">)).</span>get<span class="op">()-&gt;</span>sample<span class="op">(</span>rng<span class="op">,</span> <span class="fl">0.0</span><span class="op">,</span> <span class="fl">1.0</span><span class="op">);</span></span>
<span id="cb6-16"><a href="#cb6-16" tabindex="-1"></a>    <span class="cf">return</span> transmission_time<span class="op">::</span>sample<span class="op">(</span>rng<span class="op">,</span> t<span class="op">,</span> m<span class="op">);</span></span>
<span id="cb6-17"><a href="#cb6-17" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb6-18"><a href="#cb6-18" tabindex="-1"></a>  </span>
<span id="cb6-19"><a href="#cb6-19" tabindex="-1"></a>  <span class="kw">virtual</span> <span class="dt">double</span> survivalprobability<span class="op">(</span><span class="dt">interval_t</span> tau<span class="op">)</span> <span class="at">const</span> <span class="kw">override</span> <span class="op">{</span></span>
<span id="cb6-20"><a href="#cb6-20" tabindex="-1"></a>    <span class="dt">double</span> p <span class="op">=</span> <span class="fl">0.0</span><span class="op">;</span></span>
<span id="cb6-21"><a href="#cb6-21" tabindex="-1"></a>    <span class="cf">for</span><span class="op">(</span><span class="bu">std::</span>size_t i<span class="op">=</span><span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> times<span class="op">.</span>size<span class="op">();</span> <span class="op">++</span>i<span class="op">)</span></span>
<span id="cb6-22"><a href="#cb6-22" tabindex="-1"></a>      p <span class="op">+=</span> weights<span class="op">.</span>at<span class="op">(</span>i<span class="op">)</span> <span class="op">*</span> times<span class="op">.</span>at<span class="op">(</span>i<span class="op">).</span>get<span class="op">()-&gt;</span>survivalprobability<span class="op">(</span>tau<span class="op">);</span></span>
<span id="cb6-23"><a href="#cb6-23" tabindex="-1"></a>    <span class="cf">return</span> p<span class="op">;</span></span>
<span id="cb6-24"><a href="#cb6-24" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb6-25"><a href="#cb6-25" tabindex="-1"></a></span>
<span id="cb6-26"><a href="#cb6-26" tabindex="-1"></a>  <span class="kw">virtual</span> <span class="dt">double</span> density<span class="op">(</span><span class="dt">interval_t</span> tau<span class="op">)</span> <span class="at">const</span> <span class="kw">override</span> <span class="op">{</span></span>
<span id="cb6-27"><a href="#cb6-27" tabindex="-1"></a>    <span class="dt">double</span> p <span class="op">=</span> <span class="fl">0.0</span><span class="op">;</span></span>
<span id="cb6-28"><a href="#cb6-28" tabindex="-1"></a>    <span class="cf">for</span><span class="op">(</span><span class="bu">std::</span>size_t i<span class="op">=</span><span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> times<span class="op">.</span>size<span class="op">();</span> <span class="op">++</span>i<span class="op">)</span></span>
<span id="cb6-29"><a href="#cb6-29" tabindex="-1"></a>      p <span class="op">+=</span> weights<span class="op">.</span>at<span class="op">(</span>i<span class="op">)</span> <span class="op">*</span> times<span class="op">.</span>at<span class="op">(</span>i<span class="op">).</span>get<span class="op">()-&gt;</span>density<span class="op">(</span>tau<span class="op">);</span></span>
<span id="cb6-30"><a href="#cb6-30" tabindex="-1"></a>    <span class="cf">return</span> p<span class="op">;</span></span>
<span id="cb6-31"><a href="#cb6-31" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb6-32"><a href="#cb6-32" tabindex="-1"></a>  <span class="bu">std::</span>vector<span class="op">&lt;</span>transmission_time_R<span class="op">&gt;</span> times<span class="op">;</span></span>
<span id="cb6-33"><a href="#cb6-33" tabindex="-1"></a>  <span class="bu">std::</span>vector<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> weights<span class="op">;</span></span>
<span id="cb6-34"><a href="#cb6-34" tabindex="-1"></a>  <span class="at">mutable</span> <span class="bu">std::</span>discrete_distribution<span class="op">&lt;</span><span class="bu">std::</span>size_t<span class="op">&gt;</span> pick<span class="op">;</span></span>
<span id="cb6-35"><a href="#cb6-35" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb6-36"><a href="#cb6-36" tabindex="-1"></a></span>
<span id="cb6-37"><a href="#cb6-37" tabindex="-1"></a><span class="op">[[</span><span class="at">cpp11</span><span class="op">::</span><span class="at">linking_to</span><span class="op">(</span><span class="st">"BH"</span><span class="op">)]]</span></span>
<span id="cb6-38"><a href="#cb6-38" tabindex="-1"></a><span class="op">[[</span><span class="at">cpp11</span><span class="op">::</span><span class="at">linking_to</span><span class="op">(</span><span class="st">"NEXTNetR"</span><span class="op">)]]</span></span>
<span id="cb6-39"><a href="#cb6-39" tabindex="-1"></a><span class="op">[[</span><span class="at">cpp11</span><span class="op">::</span><span class="at">register</span><span class="op">]]</span></span>
<span id="cb6-40"><a href="#cb6-40" tabindex="-1"></a>SEXP mixture_time<span class="op">(</span>list times<span class="op">,</span> doubles weights<span class="op">)</span> <span class="op">{</span></span>
<span id="cb6-41"><a href="#cb6-41" tabindex="-1"></a>  <span class="co">// Validate parameters</span></span>
<span id="cb6-42"><a href="#cb6-42" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>times<span class="op">.</span>size<span class="op">()</span> <span class="op">!=</span> weights<span class="op">.</span>size<span class="op">())</span></span>
<span id="cb6-43"><a href="#cb6-43" tabindex="-1"></a>    <span class="cf">throw</span> <span class="bu">std::</span>runtime_error<span class="op">(</span><span class="st">"number of distributions and weights must agree"</span><span class="op">);</span></span>
<span id="cb6-44"><a href="#cb6-44" tabindex="-1"></a></span>
<span id="cb6-45"><a href="#cb6-45" tabindex="-1"></a>  <span class="co">// Create object</span></span>
<span id="cb6-46"><a href="#cb6-46" tabindex="-1"></a>  <span class="kw">auto</span> r <span class="op">=</span> <span class="bu">std::</span>make_unique<span class="op">&lt;</span>mixture_time_impl<span class="op">&gt;();</span></span>
<span id="cb6-47"><a href="#cb6-47" tabindex="-1"></a>  </span>
<span id="cb6-48"><a href="#cb6-48" tabindex="-1"></a>  <span class="co">// Set individual distributions and weights</span></span>
<span id="cb6-49"><a href="#cb6-49" tabindex="-1"></a>  r<span class="op">-&gt;</span>times<span class="op">.</span>reserve<span class="op">(</span>times<span class="op">.</span>size<span class="op">());</span></span>
<span id="cb6-50"><a href="#cb6-50" tabindex="-1"></a>  r<span class="op">-&gt;</span>weights<span class="op">.</span>reserve<span class="op">(</span>times<span class="op">.</span>size<span class="op">());</span></span>
<span id="cb6-51"><a href="#cb6-51" tabindex="-1"></a>  <span class="dt">double</span> ws <span class="op">=</span> <span class="fl">0.0</span><span class="op">;</span></span>
<span id="cb6-52"><a href="#cb6-52" tabindex="-1"></a>  <span class="cf">for</span><span class="op">(</span><span class="dt">R_xlen_t</span> i<span class="op">=</span><span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> times<span class="op">.</span>size<span class="op">();</span> <span class="op">++</span>i<span class="op">)</span></span>
<span id="cb6-53"><a href="#cb6-53" tabindex="-1"></a>      ws <span class="op">+=</span> weights<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb6-54"><a href="#cb6-54" tabindex="-1"></a>  <span class="cf">for</span><span class="op">(</span><span class="dt">R_xlen_t</span> i<span class="op">=</span><span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> times<span class="op">.</span>size<span class="op">();</span> <span class="op">++</span>i<span class="op">)</span> <span class="op">{</span></span>
<span id="cb6-55"><a href="#cb6-55" tabindex="-1"></a>    r<span class="op">-&gt;</span>times<span class="op">.</span>push_back<span class="op">((</span>transmission_time_R<span class="op">)</span>times<span class="op">[</span>i<span class="op">]);</span></span>
<span id="cb6-56"><a href="#cb6-56" tabindex="-1"></a>    r<span class="op">-&gt;</span>weights<span class="op">.</span>push_back<span class="op">(</span>weights<span class="op">[</span>i<span class="op">]</span> <span class="op">/</span> ws<span class="op">);</span></span>
<span id="cb6-57"><a href="#cb6-57" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb6-58"><a href="#cb6-58" tabindex="-1"></a>  r<span class="op">-&gt;</span>pick <span class="op">=</span> <span class="bu">std::</span>discrete_distribution<span class="op">&lt;</span><span class="bu">std::</span>size_t<span class="op">&gt;(</span></span>
<span id="cb6-59"><a href="#cb6-59" tabindex="-1"></a>      weights<span class="op">.</span>begin<span class="op">(),</span> weights<span class="op">.</span>end<span class="op">());</span></span>
<span id="cb6-60"><a href="#cb6-60" tabindex="-1"></a></span>
<span id="cb6-61"><a href="#cb6-61" tabindex="-1"></a>  <span class="co">// Return created object</span></span>
<span id="cb6-62"><a href="#cb6-62" tabindex="-1"></a>  <span class="cf">return</span> transmission_time_R<span class="op">(</span>r<span class="op">.</span>release<span class="op">());</span></span>
<span id="cb6-63"><a href="#cb6-63" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>We could now compile this function externally and load the resulting
shared library into R. However, <a href="https://cpp11.r-lib.org" class="external-link">cpp11</a> provides as simpler
way in the form of the <code><a href="https://cpp11.r-lib.org/reference/cpp_source.html" class="external-link">cpp_source()</a></code> function. This function
takes care of compiling, linking and loading the code, and makes all
functions marked with <code>[[cpp11::register]]</code> available to
R.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://cpp11.r-lib.org/reference/cpp_source.html" class="external-link">cpp_source</a></span><span class="op">(</span><span class="st">'mixture_time.cpp'</span>, dir<span class="op">=</span><span class="st">"/tmp/test"</span>, clean<span class="op">=</span><span class="cn">FALSE</span>, cxx_std<span class="op">=</span><span class="st">"CXX17"</span><span class="op">)</span></span></code></pre></div>
<p>We can now use <code>mixture_time</code> as we would use any of the
other distributions provided by NEXTNetR. For example, to create a
mixture of an exponential distribution with mean 5 and a log-normal
distribution with mean 200 and variance 500, weighted so that 30% of
samples come from the exponential distribution, we can do</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">psi</span> <span class="op">&lt;-</span> <span class="fu">mixture_time</span><span class="op">(</span>times<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="../reference/time_distributions.html">exponential_time</a></span><span class="op">(</span><span class="fl">1</span><span class="op">/</span><span class="fl">10</span><span class="op">)</span>,</span>
<span>                    <span class="fu"><a href="../reference/time_distributions.html">lognormal_time</a></span><span class="op">(</span><span class="fl">200</span>, <span class="fl">500</span><span class="op">)</span><span class="op">)</span>, weights<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.3</span>, <span class="fl">0.7</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>To test this we sample from the newly created distribution using
<code>time_sample</code></p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">samples</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/time_functions.html">time_sample</a></span><span class="op">(</span><span class="fl">1e5</span>, <span class="va">psi</span>, t<span class="op">=</span><span class="fl">10</span>, m<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p>and use <code>time_density</code> and
<code>time_survivalprobability</code> to compare the distribution of our
samples (in blue) to the theoretical distribution (in black) to check
that everything works correctly</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">samples.ecdf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/ecdf.html" class="external-link">ecdf</a></span><span class="op">(</span><span class="va">samples</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rpkgs.datanovia.com/ggpubr/reference/ggarrange.html" class="external-link">ggarrange</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">lims</a></span><span class="op">(</span>x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">300</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html" class="external-link">geom_histogram</a></span><span class="op">(</span>data<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>time<span class="op">=</span><span class="va">samples</span><span class="op">)</span>,</span>
<span>                   <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">time</span>, y<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes_eval.html" class="external-link">after_stat</a></span><span class="op">(</span><span class="va">density</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                   binwidth<span class="op">=</span><span class="fl">2</span>, fill<span class="op">=</span><span class="st">"cornflowerblue"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_function.html" class="external-link">geom_function</a></span><span class="op">(</span>fun<span class="op">=</span><span class="va">time_density</span>, n<span class="op">=</span><span class="fl">1000</span>,</span>
<span>                  args<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>timedistribution<span class="op">=</span><span class="va">psi</span>, t<span class="op">=</span><span class="fl">10</span>, m<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">lims</a></span><span class="op">(</span>x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">300</span><span class="op">)</span>, y<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x<span class="op">=</span><span class="st">'time'</span>, y<span class="op">=</span><span class="st">'survival'</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_function.html" class="external-link">geom_function</a></span><span class="op">(</span>fun<span class="op">=</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fl">1</span> <span class="op">-</span> <span class="fu">samples.ecdf</span><span class="op">(</span><span class="va">x</span><span class="op">)</span>,</span>
<span>                  color<span class="op">=</span><span class="st">"cornflowerblue"</span>, linewidth<span class="op">=</span><span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_function.html" class="external-link">geom_function</a></span><span class="op">(</span>fun<span class="op">=</span><span class="va">time_survivalprobability</span>, n<span class="op">=</span><span class="fl">1000</span>,</span>
<span>                  args<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>timedistribution<span class="op">=</span><span class="va">psi</span>, t<span class="op">=</span><span class="fl">10</span>, m<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  ncol<span class="op">=</span><span class="fl">1</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="custom_time_distributions_cpp_files/figure-html/plot_density_cdf-1.png" width="700"></p>
</div>
</div>
<div class="section level2">
<h2 id="simulations-using-our-custom-distribution">Simulations using our custom distribution<a class="anchor" aria-label="anchor" href="#simulations-using-our-custom-distribution"></a>
</h2>
<p>Our custom distribution in simulations in the same way as built-in
distributions, see <code>vignette(NEXTNetR)</code> for a step by step
explanation of this</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nw</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/erdos_renyi_network.html">erdos_renyi_network</a></span><span class="op">(</span><span class="fl">1e5</span>, <span class="fl">5</span><span class="op">)</span></span>
<span><span class="va">sim</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simulation.html">simulation</a></span><span class="op">(</span><span class="va">nw</span>, <span class="va">psi</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/simulation_functions.html">simulation_addinfections</a></span><span class="op">(</span><span class="va">sim</span>, nodes<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, times<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.0</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">events</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simulation_run.html">simulation_run</a></span><span class="op">(</span><span class="va">sim</span>, stop<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>total_infected<span class="op">=</span><span class="fl">300e3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">events</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">time</span>, y<span class="op">=</span><span class="va">infected</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="custom_time_distributions_cpp_files/figure-html/plot_trajectory-1.png" width="700"></p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Florian Pflug, Samuel Cure.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
